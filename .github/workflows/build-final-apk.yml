name: Build Fixed Chess Bot APK

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    steps:
    - name: ðŸ“¥ Checkout Repository  
      uses: actions/checkout@v4
      
    - name: ðŸ“¦ Extract and Fix server.zip
      run: |
        echo "ðŸ” Extracting server.zip..."
        unzip -o server.zip
        
        echo "ðŸ”§ Applying fixes to Android project..."
        cd fixed-chess-bot-app
        
        # Remove conflicting files
        rm -f build.gradle.kts settings.gradle.kts app/build.gradle.kts
        
        # Copy fixed configuration files
        cp -r ../fixed-app/* .
        
        # Fix source directory structure (move from src/src to src)
        if [ -d "app/src/src" ]; then
          echo "ðŸ“ Fixing source directory structure..."
          mv app/src/src/main app/src/main-new
          rm -rf app/src/main
          mv app/src/main-new app/src/main
        fi
        
        echo "âœ… Project structure fixed"
        find . -name "*.gradle" -o -name "AndroidManifest.xml" | head -5
        
    - name: â˜• Set up JDK 11 (Compatible with AGP 7.4.2)
      uses: actions/setup-java@v4
      with:
        java-version: '11'
        distribution: 'temurin'
        
    - name: ðŸ“± Setup Android SDK
      uses: android-actions/setup-android@v3
      with:
        api-level: 29
        build-tools: 29.0.3
        
    - name: ðŸ” Accept Android Licenses
      run: yes | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --licenses
      
    - name: ðŸ”§ Setup Build Environment
      working-directory: fixed-chess-bot-app
      run: |
        echo "sdk.dir=$ANDROID_HOME" > local.properties
        chmod +x gradlew
        
        echo "ðŸ“‹ Gradle version:"
        ./gradlew --version
        
    - name: ðŸ”¨ Build APK
      working-directory: fixed-chess-bot-app
      run: |
        echo "ðŸ”¨ Building Chess Bot APK..."
        ./gradlew clean assembleDebug --stacktrace --info
        
        echo "ðŸ” Locating APK files..."
        APK_FILES=$(find . -name "*.apk")
        if [ -z "$APK_FILES" ]; then
          echo "âŒ No APK files found"
          find . -name "build" -type d -exec ls -la {} ;
          exit 1
        fi
        
        echo "âœ… APK files generated:"
        for apk in $APK_FILES; do
          echo "ðŸ“± $apk ($(du -h $apk | cut -f1))"
        done
        
    - name: ðŸ“¤ Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: chess-bot-redmi9-activ-fixed
        path: |
          fixed-chess-bot-app/**/*.apk
          fixed-chess-bot-app/app/build/outputs/apk/**/*
        retention-days: 30
        
    - name: ðŸ“‹ Success Report
      run: |
        echo "# ðŸŽ‰ Chess Bot APK Build SUCCESS!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "âœ… **APK Generated Successfully for Redmi 9 Activ**" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ”§ Issues Fixed:" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Conflicting Gradle versions resolved (AGP 7.4.2, Kotlin 1.8.10)" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Package name corrected (com.chessbot)" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Source directory structure fixed" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… AndroidManifest.xml aligned with code" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… MIUI permissions for Redmi 9 Activ added" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“± Install on Redmi 9 Activ:" >> $GITHUB_STEP_SUMMARY
        echo "1. Download APK from artifacts above" >> $GITHUB_STEP_SUMMARY
        echo "2. Enable Unknown Sources in MIUI Security" >> $GITHUB_STEP_SUMMARY
        echo "3. Install APK and grant overlay + accessibility permissions" >> $GITHUB_STEP_SUMMARY
        echo "4. Disable battery optimization for the app" >> $GITHUB_STEP_SUMMARY
