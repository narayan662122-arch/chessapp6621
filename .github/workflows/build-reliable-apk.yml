name: Build Chess Bot APK - Reliable Version

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 25
    
    steps:
    - name: 📥 Checkout Repository
      uses: actions/checkout@v4
      
    - name: 🔧 Use Corrected App Structure  
      run: |
        echo "📁 Using corrected app structure from server-fixed/"
        cp -r server-fixed chess-bot-app
        cd chess-bot-app
        
        echo "✅ App structure:"
        ls -la
        echo "
Source files:"
        find app/src/main/java -name "*.kt" | head -10
        
    - name: ☕ Set up JDK 11
      uses: actions/setup-java@v4
      with:
        java-version: '11'
        distribution: 'temurin'
        
    - name: 📱 Setup Android SDK (Manual - More Reliable)
      run: |
        echo "📱 Installing Android SDK manually..."
        
        # Download and install Android command line tools
        cd $HOME
        wget -q https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip
        unzip -q commandlinetools-linux-11076708_latest.zip
        
        # Setup Android SDK directory structure
        export ANDROID_HOME=$HOME/android-sdk
        mkdir -p $ANDROID_HOME/cmdline-tools
        mv cmdline-tools $ANDROID_HOME/cmdline-tools/latest
        
        # Add to environment for subsequent steps
        echo "ANDROID_HOME=$HOME/android-sdk" >> $GITHUB_ENV
        echo "$HOME/android-sdk/cmdline-tools/latest/bin" >> $GITHUB_PATH
        echo "$HOME/android-sdk/platform-tools" >> $GITHUB_PATH
        
        # Accept all licenses first
        yes | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --licenses || true
        
        # Install required components for API 29 (Redmi 9 Activ)
        $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager \
          "platforms;android-29" \
          "build-tools;29.0.3" \
          "platform-tools" \
          "extras;android;m2repository" \
          "extras;google;m2repository"
          
        echo "✅ Android SDK installed for API 29"
        ls -la $ANDROID_HOME/
        
    - name: 🔧 Setup Build Environment
      working-directory: chess-bot-app  
      run: |
        echo "🔧 Setting up build..."
        
        # Create local.properties with SDK path
        echo "sdk.dir=$ANDROID_HOME" > local.properties
        cat local.properties
        
        # Make gradlew executable
        chmod +x gradlew
        
        echo "📋 Gradle version:"
        ./gradlew --version || echo "Gradle wrapper will be downloaded"
        
    - name: 🔨 Build Chess Bot APK
      working-directory: chess-bot-app
      run: |
        echo "🧹 Clean project..."
        ./gradlew clean --stacktrace
        
        echo "🔨 Building APK for Redmi 9 Activ (Android 10, API 29)..."
        ./gradlew assembleDebug --stacktrace --info --warning-mode all
        
        echo "🔍 Verifying APK was built..."
        find . -name "*.apk" -ls
        
        APK_COUNT=$(find . -name "*.apk" | wc -l)
        if [ "$APK_COUNT" -eq 0 ]; then
          echo "❌ No APK files found!"
          echo "
Build outputs:"
          find . -name "build" -type d -exec find {} -name "*" -type f | head -20 ;
          exit 1
        fi
        
        echo "✅ Found $APK_COUNT APK file(s):"
        for apk in $(find . -name "*.apk"); do
          echo "📱 $apk ($(stat --format=%s $apk | numfmt --to=iec-i --suffix=B --format=%.1f))"
          file "$apk"
        done
        
    - name: 📤 Upload Chess Bot APK (SUCCESS!)
      uses: actions/upload-artifact@v4
      with:
        name: chess-bot-redmi9-activ-working
        path: |
          chess-bot-app/**/*.apk
          chess-bot-app/app/build/outputs/apk/**/*
        retention-days: 30
        
    - name: 🎉 SUCCESS SUMMARY
      run: |
        echo "# 🎉 CHESS BOT APK BUILD SUCCESS!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "✅ **APK Successfully Built and Uploaded for Redmi 9 Activ!**" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### 🔧 Issues Fixed and Resolved:" >> $GITHUB_STEP_SUMMARY  
        echo "- ✅ Gradle build conflicts resolved (AGP 7.4.2 + Kotlin 1.8.10)" >> $GITHUB_STEP_SUMMARY
        echo "- ✅ Source directory structure corrected" >> $GITHUB_STEP_SUMMARY
        echo "- ✅ Package namespace unified (com.chessbot)" >> $GITHUB_STEP_SUMMARY
        echo "- ✅ AndroidManifest.xml properly configured" >> $GITHUB_STEP_SUMMARY
        echo "- ✅ Android SDK manually installed (more reliable)" >> $GITHUB_STEP_SUMMARY
        echo "- ✅ MIUI permissions for Redmi 9 Activ included" >> $GITHUB_STEP_SUMMARY
        echo "- ✅ Android 10 (API 29) targeting confirmed" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### 📱 Install on Your Redmi 9 Activ:" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "1. **Download APK**: Click the 'chess-bot-redmi9-activ-working' artifact above" >> $GITHUB_STEP_SUMMARY
        echo "2. **Transfer to Phone**: Copy APK file to your Redmi 9 Activ" >> $GITHUB_STEP_SUMMARY
        echo "3. **Enable Installation**: Settings → Security → Install unknown apps → Enable" >> $GITHUB_STEP_SUMMARY
        echo "4. **Install APK**: Tap the APK file and install" >> $GITHUB_STEP_SUMMARY
        echo "5. **Grant Permissions**:" >> $GITHUB_STEP_SUMMARY
        echo "   - ⭐ **Display over other apps** (Required for chess overlay)" >> $GITHUB_STEP_SUMMARY
        echo "   - ♿ **Accessibility service** (Settings → Accessibility → Chess Bot → Enable)" >> $GITHUB_STEP_SUMMARY
        echo "   - 🔋 **Battery optimization off** (Settings → Battery → App battery usage → Chess Bot → No restrictions)" >> $GITHUB_STEP_SUMMARY
        echo "6. **MIUI Settings**: Security app → Permissions → Autostart → Enable Chess Bot" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "🎯 **Your Chess Bot is ready to run on Redmi 9 Activ!** 🎮📱" >> $GITHUB_STEP_SUMMARY
