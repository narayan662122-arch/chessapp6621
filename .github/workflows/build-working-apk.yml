name: Build Working Chess Bot APK

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    steps:
    - name: ðŸ“¥ Checkout Repository  
      uses: actions/checkout@v4
      
    - name: ðŸ”§ Use Corrected App Structure
      run: |
        echo "ðŸ“ Using pre-corrected app structure from server-fixed/"
        
        # Copy the corrected structure to build location
        cp -r server-fixed chess-bot-app
        cd chess-bot-app
        
        echo "âœ… Using corrected app structure:"
        echo "ðŸ“ Project root:"
        ls -la
        
        echo "
ðŸ“„ Build files:"
        find . -name "*.gradle" | head -5
        
        echo "
ðŸ“± Source files:"  
        find app/src/main/java -name "*.kt" | head -10
        
        echo "
ðŸ“‹ AndroidManifest:"
        ls -la app/src/main/AndroidManifest.xml
        
    - name: â˜• Set up JDK 11 (Compatible with AGP 7.4.2)
      uses: actions/setup-java@v4
      with:
        java-version: '11'
        distribution: 'temurin'
        
    - name: ðŸ“± Setup Android SDK
      uses: android-actions/setup-android@v3
      with:
        api-level: 29
        build-tools: 29.0.3
        
    - name: ðŸ” Accept Android Licenses  
      run: yes | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --licenses
      
    - name: ðŸ”§ Setup Build Environment
      working-directory: chess-bot-app
      run: |
        echo "ðŸ”§ Setting up build environment..."
        
        # Create local.properties
        echo "sdk.dir=$ANDROID_HOME" > local.properties
        
        # Create gradle wrapper if it doesn't exist
        if [ ! -f "gradlew" ]; then
          echo "ðŸ“¦ Creating gradle wrapper..."
          gradle wrapper
        fi
        
        chmod +x gradlew
        
        echo "ðŸ“‹ Gradle version:"
        ./gradlew --version
        
        echo "ðŸ” Project validation:"
        ./gradlew projects
        
    - name: ðŸ”¨ Build APK (Clean Build)
      working-directory: chess-bot-app
      run: |
        echo "ðŸ§¹ Clean build..."
        ./gradlew clean --stacktrace
        
        echo "ðŸ”¨ Building APK for Redmi 9 Activ..."
        ./gradlew assembleDebug --stacktrace --info
        
    - name: ðŸ” Verify APK Generated
      working-directory: chess-bot-app
      run: |
        echo "ðŸ” Searching for APK files..."
        find . -name "*.apk" -ls
        
        APK_FILES=$(find . -name "*.apk")
        if [ -z "$APK_FILES" ]; then
          echo "âŒ No APK files found!"
          echo "
ðŸ“ Build output directories:"
          find . -name "build" -type d -exec ls -la {} ;
          exit 1
        fi
        
        echo "âœ… APK files found:"
        for apk in $APK_FILES; do
          echo "ðŸ“± $apk"
          file "$apk"
          ls -lh "$apk"
        done
        
    - name: ðŸ“¤ Upload Chess Bot APK
      uses: actions/upload-artifact@v4
      with:
        name: chess-bot-redmi9-activ-final
        path: |
          chess-bot-app/**/*.apk
          chess-bot-app/app/build/outputs/apk/**/*
        retention-days: 30
        
    - name: ðŸ“‹ Build Success Report
      run: |
        echo "# ðŸŽ‰ Chess Bot APK Build SUCCESS!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "âœ… **APK Successfully Generated for Redmi 9 Activ**" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ”§ All Issues Fixed:" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Gradle version conflicts resolved (AGP 7.4.2 + Kotlin 1.8.10)" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Source directory structure corrected (app/src/main/java/com/chessbot/)" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Package namespace unified (com.chessbot throughout)" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… AndroidManifest.xml properly configured" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… MIUI permissions added for Redmi 9 Activ compatibility" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Android API 29 targeting confirmed" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“± Install Instructions for Redmi 9 Activ:" >> $GITHUB_STEP_SUMMARY
        echo "1. **Download APK**: Click 'chess-bot-redmi9-activ-final' artifact" >> $GITHUB_STEP_SUMMARY
        echo "2. **Enable Developer Options**: Settings â†’ About â†’ Tap MIUI Version 7 times" >> $GITHUB_STEP_SUMMARY
        echo "3. **Allow Installation**: Security â†’ Install unknown apps â†’ Enable" >> $GITHUB_STEP_SUMMARY
        echo "4. **Install APK**: Transfer to device and install" >> $GITHUB_STEP_SUMMARY
        echo "5. **Grant Permissions**:" >> $GITHUB_STEP_SUMMARY
        echo "   - Overlay permission (Display over other apps)" >> $GITHUB_STEP_SUMMARY
        echo "   - Accessibility service (Settings â†’ Accessibility â†’ Chess Bot)" >> $GITHUB_STEP_SUMMARY
        echo "   - Disable battery optimization" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸŽ¯ **Your Chess Bot APK is ready for Redmi 9 Activ!** ðŸ“±" >> $GITHUB_STEP_SUMMARY
