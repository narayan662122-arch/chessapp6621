name: Build Working Chess Bot APK

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    steps:
    - name: 📥 Checkout Repository  
      uses: actions/checkout@v4
      
    - name: 🔧 Use Corrected App Structure
      run: |
        echo "📁 Using pre-corrected app structure from server-fixed/"
        
        # Copy the corrected structure to build location
        cp -r server-fixed chess-bot-app
        cd chess-bot-app
        
        echo "✅ Using corrected app structure:"
        echo "📁 Project root:"
        ls -la
        
        echo "
📄 Build files:"
        find . -name "*.gradle" | head -5
        
        echo "
📱 Source files:"  
        find app/src/main/java -name "*.kt" | head -10
        
        echo "
📋 AndroidManifest:"
        ls -la app/src/main/AndroidManifest.xml
        
    - name: ☕ Set up JDK 11 (Compatible with AGP 7.4.2)
      uses: actions/setup-java@v4
      with:
        java-version: '11'
        distribution: 'temurin'
        
    - name: 📱 Setup Android SDK
      uses: android-actions/setup-android@v3
      with:
        api-level: 29
        build-tools: 29.0.3
        
    - name: 🔐 Accept Android Licenses  
      run: yes | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --licenses
      
    - name: 🔧 Setup Build Environment
      working-directory: chess-bot-app
      run: |
        echo "🔧 Setting up build environment..."
        
        # Create local.properties
        echo "sdk.dir=$ANDROID_HOME" > local.properties
        
        # Create gradle wrapper if it doesn't exist
        if [ ! -f "gradlew" ]; then
          echo "📦 Creating gradle wrapper..."
          gradle wrapper
        fi
        
        chmod +x gradlew
        
        echo "📋 Gradle version:"
        ./gradlew --version
        
        echo "🔍 Project validation:"
        ./gradlew projects
        
    - name: 🔨 Build APK (Clean Build)
      working-directory: chess-bot-app
      run: |
        echo "🧹 Clean build..."
        ./gradlew clean --stacktrace
        
        echo "🔨 Building APK for Redmi 9 Activ..."
        ./gradlew assembleDebug --stacktrace --info
        
    - name: 🔍 Verify APK Generated
      working-directory: chess-bot-app
      run: |
        echo "🔍 Searching for APK files..."
        find . -name "*.apk" -ls
        
        APK_FILES=$(find . -name "*.apk")
        if [ -z "$APK_FILES" ]; then
          echo "❌ No APK files found!"
          echo "
📁 Build output directories:"
          find . -name "build" -type d -exec ls -la {} ;
          exit 1
        fi
        
        echo "✅ APK files found:"
        for apk in $APK_FILES; do
          echo "📱 $apk"
          file "$apk"
          ls -lh "$apk"
        done
        
    - name: 📤 Upload Chess Bot APK
      uses: actions/upload-artifact@v4
      with:
        name: chess-bot-redmi9-activ-final
        path: |
          chess-bot-app/**/*.apk
          chess-bot-app/app/build/outputs/apk/**/*
        retention-days: 30
        
    - name: 📋 Build Success Report
      run: |
        echo "# 🎉 Chess Bot APK Build SUCCESS!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "✅ **APK Successfully Generated for Redmi 9 Activ**" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### 🔧 All Issues Fixed:" >> $GITHUB_STEP_SUMMARY
        echo "- ✅ Gradle version conflicts resolved (AGP 7.4.2 + Kotlin 1.8.10)" >> $GITHUB_STEP_SUMMARY
        echo "- ✅ Source directory structure corrected (app/src/main/java/com/chessbot/)" >> $GITHUB_STEP_SUMMARY
        echo "- ✅ Package namespace unified (com.chessbot throughout)" >> $GITHUB_STEP_SUMMARY
        echo "- ✅ AndroidManifest.xml properly configured" >> $GITHUB_STEP_SUMMARY
        echo "- ✅ MIUI permissions added for Redmi 9 Activ compatibility" >> $GITHUB_STEP_SUMMARY
        echo "- ✅ Android API 29 targeting confirmed" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### 📱 Install Instructions for Redmi 9 Activ:" >> $GITHUB_STEP_SUMMARY
        echo "1. **Download APK**: Click 'chess-bot-redmi9-activ-final' artifact" >> $GITHUB_STEP_SUMMARY
        echo "2. **Enable Developer Options**: Settings → About → Tap MIUI Version 7 times" >> $GITHUB_STEP_SUMMARY
        echo "3. **Allow Installation**: Security → Install unknown apps → Enable" >> $GITHUB_STEP_SUMMARY
        echo "4. **Install APK**: Transfer to device and install" >> $GITHUB_STEP_SUMMARY
        echo "5. **Grant Permissions**:" >> $GITHUB_STEP_SUMMARY
        echo "   - Overlay permission (Display over other apps)" >> $GITHUB_STEP_SUMMARY
        echo "   - Accessibility service (Settings → Accessibility → Chess Bot)" >> $GITHUB_STEP_SUMMARY
        echo "   - Disable battery optimization" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "🎯 **Your Chess Bot APK is ready for Redmi 9 Activ!** 📱" >> $GITHUB_STEP_SUMMARY
