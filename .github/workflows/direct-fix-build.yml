name: Direct Fix Chess Bot APK Build

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
    - name: ðŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      
    - name: â˜• Set up JDK 11
      uses: actions/setup-java@v4
      with:
        java-version: '11'
        distribution: 'temurin'
        
    - name: ðŸ“¦ Extract and Fix server.zip In-Place
      run: |
        echo "ðŸ“¦ Extracting server.zip..."
        unzip -o server.zip
        cd fixed-chess-bot-app
        
        echo "ðŸ”§ Fixing build configuration..."
        
        # Remove conflicting files
        rm -f build.gradle.kts settings.gradle.kts app/build.gradle.kts || true
        
        # Create simple working build.gradle
        cat > build.gradle << 'EOF'
buildscript {
    repositories {
        google()
        mavenCentral()
    }
    dependencies {
        classpath 'com.android.tools.build:gradle:7.0.4'
        classpath 'org.jetbrains.kotlin:kotlin-gradle-plugin:1.6.10'
    }
}

allprojects {
    repositories {
        google()
        mavenCentral()
    }
}
EOF

        cat > settings.gradle << 'EOF'
include ':app'
EOF

        cat > app/build.gradle << 'EOF'
plugins {
    id 'com.android.application'
    id 'kotlin-android'
}

android {
    compileSdk 29

    defaultConfig {
        applicationId "com.chessbot"
        minSdk 24
        targetSdk 29
        versionCode 1
        versionName "1.0"
    }

    buildTypes {
        release {
            minifyEnabled false
        }
    }
    
    compileOptions {
        sourceCompatibility JavaVersion.VERSION_1_8
        targetCompatibility JavaVersion.VERSION_1_8
    }
}

dependencies {
    implementation 'androidx.core:core-ktx:1.6.0'
    implementation 'androidx.appcompat:appcompat:1.3.1'
    implementation 'com.google.android.material:material:1.4.0'
    implementation 'com.squareup.okhttp3:okhttp:4.9.1'
}
EOF
        
        # Fix source structure
        if [ -d "app/src/src/main" ]; then
          rm -rf app/src/main || true
          mv app/src/src/main app/src/main
        fi
        
        echo "âœ… Fixed structure"
        ls -la
        
    - name: ðŸ“± Setup Android SDK
      run: |
        wget -q https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip
        unzip -q commandlinetools-linux-9477386_latest.zip
        export ANDROID_HOME=$PWD/android-sdk
        mkdir -p $ANDROID_HOME/cmdline-tools
        mv cmdline-tools $ANDROID_HOME/cmdline-tools/latest
        echo "ANDROID_HOME=$PWD/android-sdk" >> $GITHUB_ENV
        echo "$PWD/android-sdk/cmdline-tools/latest/bin" >> $GITHUB_PATH
        yes | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --licenses || true
        $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager "platforms;android-29" "build-tools;29.0.3" "platform-tools" || true
        
    - name: ðŸ”¨ Build APK
      working-directory: fixed-chess-bot-app
      run: |
        echo "sdk.dir=$ANDROID_HOME" > local.properties
        chmod +x gradlew
        ./gradlew clean assembleDebug --stacktrace
        find . -name "*.apk" -ls
        
    - name: ðŸ“¤ Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: chess-bot-final-working
        path: fixed-chess-bot-app/**/*.apk
        retention-days: 30
